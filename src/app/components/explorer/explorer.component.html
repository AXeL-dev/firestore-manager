<nz-layout class="left-layout">
  <nz-header>
      <img
        width="40"
        alt="Firestore Manager Logo"
        src="assets/images/firestore_logo.png"
      />
      <span>Firestore Manager</span>
      <div class="spacer"></div>
      <a
        class="toolbar-icon"
        nz-tooltip
        nzTooltipTitle="{{ 'Report a bug' | translate }}"
        nzTooltipPlacement="left"
        href="https://github.com/AXeL-dev/firestore-manager/issues"
        target="_blank"
      >
        <i nz-icon nzType="bug" nzTheme="outline"></i>
      </a>
      <span
        *ngIf="!isWebExtension"
        class="toolbar-icon"
        nz-tooltip
        nzTooltipTitle="{{ 'Settings' | translate }}"
        nzTooltipPlacement="left"
        (click)="isSettingsDrawerVisible = true"
      >
        <i nz-icon nzType="setting" nzTheme="outline"></i>
      </span>
      <span
        *ngIf="!isWebExtension"
        class="toolbar-icon"
        nz-tooltip
        nzTooltipTitle="{{ 'Go back to main page' | translate }}"
        nzTooltipPlacement="left"
        (click)="onGoBackIconClick()"
      >
        <i nz-icon nzType="logout" nzTheme="outline"></i>
      </span>
  </nz-header>
  <nz-layout>
    <nz-sider nzTheme="light" nzWidth="300px">
      <nz-spin nzTip="{{ collectionListLoadingTip | translate }}..." [nzSpinning]="isCollectionListLoading">
        <div *ngIf="!enableCollectionDeleteMode" [ngStyle]="{ 'margin-bottom': '10px' }">
          <nz-alert
            *ngIf="unsavedChanges && !isCollectionListLoading"
            nzBanner
            [nzMessage]="unsavedChangesTpl"
            [ngStyle]="{ 'margin': '-20px -20px 10px' }"
          >
            <ng-template #unsavedChangesTpl>
              <div nz-row nzGutter="8">
                <div nz-col nzSpan="16">
                  <span><span translate>You have some unsaved changes!</span>&nbsp;<i nz-icon nz-tooltip nzTooltipPlacement="bottom" nzTitle="{{ 'Click on \'View\' to see all the modifications.' | translate }}" nzType="question-circle" nzTheme="outline"></i></span>
                </div>
                <div nz-col nzSpan="8">
                  <button nz-button nzType="primary" (click)="onViewUnsavedChangesClick()" [ngStyle]="{ float: 'right' }"><span translate>View</span></button>
                </div>
              </div>
            </ng-template>
          </nz-alert>
          <div nz-row nzGutter="8">
            <div nz-col nzSpan="21">
                <nz-select
                  #collectionSearch
                  nzShowSearch
                  nzAllowClear
                  [nzLoading]="isSearchCollectionLoading"
                  nzPlaceHolder="{{ 'Collection' | translate }}"
                  [nzSuffixIcon]="searchIcon"
                  nzNotFoundContent="{{ 'No collection found' | translate }}"
                  [(ngModel)]="searchValue"
                  (nzOnSearch)="searchCollection($event)"
                  [ngStyle]="{ width: '100%' }"
                >
                  <nz-option *ngFor="let c of collectionList" [nzLabel]="c" [nzValue]="c"> </nz-option>
                </nz-select>
                <ng-template #searchIcon>
                  <i nz-icon nzType="search"></i>
                </ng-template>
            </div>
            <div nz-col nzSpan="3">
              <button nz-button nzType="default" [ngStyle]="{ padding: '4px' }" nz-dropdown nzTrigger="click" [nzDropdownMenu]="collectionMenu">
                <i nz-icon nzType="more" nzTheme="outline"></i>
              </button>
              <nz-dropdown-menu #collectionMenu="nzDropdownMenu">
                <ul nz-menu [ngStyle]="{ 'min-width': '140px' }">
                  <li nz-submenu nzTitle="{{ 'Add' | translate }}">
                    <ul>
                      <li nz-menu-item (click)="isAddCollectionDrawerVisible = true" translate>Collection</li>
                      <li nz-menu-item (click)="isAddDocumentDrawerVisible = collectionNodes.length ? true : false" [nzDisabled]="!collectionNodes.length" translate>Document</li>
                    </ul>
                  </li>
                  <li nz-submenu nzTitle="{{ 'Expand' | translate }}" [nzDisabled]="!collectionNodes.length">
                    <ul>
                      <li nz-menu-item (click)="expandAllCollectionNodes()" translate>All</li>
                      <li nz-menu-item (click)="collectionNodesExpandedKeys = []" translate>None</li>
                    </ul>
                  </li>
                  <li nz-menu-item (click)="onDeleteCollectionClick()" [nzDisabled]="!collectionNodes.length" translate>Delete</li>
                  <li nz-menu-item (click)="onReloadCollectionClick()" [nzDisabled]="!collectionNodes.length" translate>Reload</li>
                  <li nz-menu-divider></li>
                  <li nz-submenu nzTitle="{{ 'Import' | translate }}">
                    <ul>
                      <li nz-menu-item (click)="importFileInput.click()">JSON</li>
                    </ul>
                    <input type="file" accept=".json" [hidden]="true" (change)="onImportFileChanged($event)" #importFileInput>
                  </li>
                  <li nz-submenu nzTitle="{{ 'Export' | translate }}" [nzDisabled]="!collectionNodes.length">
                    <ul>
                      <li nz-menu-item (click)="onExportJsonClick()">JSON</li>
                    </ul>
                  </li>
                </ul>
              </nz-dropdown-menu>
            </div>
          </div>
          <nz-alert
            *ngIf="!collectionNodes.length"
            nzBanner
            nzType="info"
            nzMessage="{{ 'Welcome!' | translate }}"
            nzDescription="{{ 'Start by typing a collection name in the search box above.' | translate }}"
            [ngStyle]="{ 'margin-top': '10px' }"
            nzCloseable
          ></nz-alert>
        </div>
        <div *ngIf="enableCollectionDeleteMode" [ngStyle]="{ 'margin-bottom': '10px' }">
          <div nz-row nzGutter="8" [ngStyle]="{ 'margin-bottom': '10px' }">
            <div nz-col nzSpan="4">
              <button
                nz-button
                nzType="dashed"
                nzBlock
                nz-tooltip
                nzTooltipTitle="{{ 'Select All' | translate }}"
                nzTooltipPlacement="bottom"
                [disabled]="!collectionNodes.length"
                (click)="onSelectAllClick()"><i nz-icon nzType="check-square" nzTheme="outline"></i></button>
            </div>
            <div nz-col nzSpan="10">
              <button nz-button nzType="default" nzBlock (click)="enableCollectionDeleteMode = false"><span translate>Cancel</span></button>
            </div>
            <div nz-col nzSpan="10">
              <button nz-button
                nzType="danger"
                nzBlock
                nz-popconfirm
                [nzPopconfirmTitle]="confirmDeleteTpl"
                nzPopconfirmPlacement="bottom"
                nzCancelText="{{ 'Cancel' | translate }}"
                nzOkText="{{ 'Confirm' | translate }}"
                [disabled]="!collectionNodesCheckedKeys.length"
                (nzOnConfirm)="onCollectionDeleteConfirm()"><span translate>Delete</span></button>
              <ng-template #confirmDeleteTpl>
                <span><i nz-icon nzType="exclamation-circle" nzTheme="fill" style="color: #faad14; margin-right: 5px;"></i><strong translate>Delete?</strong></span>
                <div [ngStyle]="{ 'margin-top': '10px' }">
                  <label nz-checkbox [(ngModel)]="permanentlyDeleteDocuments"><span translate>Permanently delete documents?</span></label>
                </div>
              </ng-template>
            </div>
          </div>
          <nz-alert nzBanner [nzMessage]="deleteWarningTpl" nzCloseable>
            <ng-template #deleteWarningTpl>
              <span translate>Only documents can be permanently deleted, collections will be removed only from the browser cache! If you want to permanently delete a collection please use the</span>&nbsp;<a [href]="databaseConfig.databaseURL" target="_blank" translate>Firebase Console</a>.
            </ng-template>
          </nz-alert>
        </div>
        <nz-tree
          [nzData]="collectionNodes"
          nzAsyncData
          nzShowLine
          [nzSearchValue]="searchValue"
          [nzCheckable]="enableCollectionDeleteMode"
          [nzCheckedKeys]="collectionNodesCheckedKeys"
          [nzSelectedKeys]="collectionNodesSelectedKeys"
          [nzExpandedKeys]="collectionNodesExpandedKeys"
          [nzExpandedIcon]="expandedIconTpl"
          (nzClick)="onCollectionNodeClick($event)"
          (nzCheckBoxChange)="onCollectionNodeCheck($event)"
          (nzExpandChange)="onCollectionNodeExpand($event)"
        >
          <ng-template #expandedIconTpl let-node>
            <i *ngIf="!node.origin.isLeaf" nz-icon [nzType]="node.isLoading ? 'loading' : node.isExpanded ? 'folder-open' : 'folder'" class="ant-tree-switcher-line-icon"></i>
            <i *ngIf="node.origin.isLeaf" nz-icon nzType="file" class="ant-tree-switcher-line-icon"></i>
          </ng-template>
        </nz-tree>
      </nz-spin>
    </nz-sider>
    <nz-layout class="right-layout">
      <nz-content>
        <div class="inner-content">
          <json-editor [options]="editorOptions" (change)="onEditorDataChange($event)"></json-editor>
        </div>
      </nz-content>
    </nz-layout>
  </nz-layout>
</nz-layout>
<nz-drawer
  [nzClosable]="false"
  [nzOffsetX]="0"
  [nzWidth]="500"
  [nzVisible]="isAddCollectionDrawerVisible"
  nzTitle="{{ 'New Collection' | translate }}"
  (nzOnClose)="isAddCollectionDrawerVisible = false"
>
  <form nz-form [formGroup]="addCollectionForm" (ngSubmit)="submitForm(addCollectionForm)">
    <div nz-row>
      <div nz-col nzSpan="24">
        <nz-form-item>
          <nz-form-label nzRequired><span translate>Name</span></nz-form-label>
          <nz-form-control nzErrorTip="{{ (addCollectionForm.controls.name.errors && addCollectionForm.controls.name.errors.notUnique ? 'A collection with the same name already exists!' : 'please enter collection name') | translate }}">
            <input nz-input formControlName="name" placeholder="{{ 'my collection' | translate }}" />
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row>
      <div nz-col nzSpan="24">
        <nz-form-item>
          <nz-form-label nzRequired>
            <span>
              <span translate>Content</span>&nbsp;<i nz-icon nz-tooltip nzTooltipPlacement="bottom" nzTitle="{{ 'Content of the first document in json' | translate }}" nzType="question-circle" nzTheme="outline"></i>
            </span>
          </nz-form-label>
          <button nz-button nzType="default" nzShape="circle" nzSize="small" (click)="onRandomContentClick($event, addCollectionForm)" nz-tooltip nzTooltipTitle="{{ 'Random' | translate }}" nzTooltipPlacement="left" [ngStyle]="{ float: 'right', bottom: '-5px' }">
            <i nz-icon nzType="sync" nzTheme="outline"></i>
          </button>
          <nz-form-control nzErrorTip="{{ 'please enter a valid json content' | translate }}">
            <textarea nz-input class="tab-size" formControlName="content" spellcheck="false" [placeholder]="documentContentExample" [nzAutosize]="{ minRows: 14, maxRows: 16 }"></textarea>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div class="drawer-footer">
      <button nz-button nzType="default" (click)="isAddCollectionDrawerVisible = false" [ngStyle]="{ 'margin-right': '8px' }"><span translate>Cancel</span></button>
      <button nz-button nzType="primary" [nzLoading]="isAddCollectionButtonLoading" (click)="onAddCollectionClick()"><span translate>Add</span></button>
    </div>
  </form>
</nz-drawer>
<nz-drawer
  [nzClosable]="false"
  [nzOffsetX]="0"
  [nzWidth]="500"
  [nzVisible]="isAddDocumentDrawerVisible"
  nzTitle="{{ 'New Document' | translate }}"
  (nzOnClose)="isAddDocumentDrawerVisible = false"
>
  <form nz-form [formGroup]="addDocumentForm" (ngSubmit)="submitForm(addDocumentForm)">
    <div nz-row>
      <div nz-col nzSpan="24">
        <nz-form-item>
          <nz-form-label nzRequired><span translate>Collection</span></nz-form-label>
          <nz-form-control nzErrorTip="{{ 'please select a collection' | translate }}">
            <nz-select nzShowSearch nzAllowClear nzPlaceHolder="{{ 'Select a collection' | translate }}"  formControlName="collection">
              <nz-option *ngFor="let collection of collectionNodes" [nzLabel]="collection.title" [nzValue]="collection.key"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row>
      <div nz-col nzSpan="24">
        <nz-form-item>
          <nz-form-label nzRequired>
            <span>
              <span translate>Content</span>&nbsp;<i nz-icon nz-tooltip nzTooltipPlacement="bottom" nzTitle="{{ 'Content of the document in json' | translate }}" nzType="question-circle" nzTheme="outline"></i>
            </span>
          </nz-form-label>
          <button nz-button nzType="default" nzShape="circle" nzSize="small" (click)="onRandomContentClick($event, addDocumentForm)" nz-tooltip nzTooltipTitle="{{ 'Random' | translate }}" nzTooltipPlacement="left" [ngStyle]="{ float: 'right', bottom: '-5px' }">
            <i nz-icon nzType="sync" nzTheme="outline"></i>
          </button>
          <nz-form-control nzErrorTip="{{ 'please enter a valid json content' | translate }}">
            <textarea nz-input class="tab-size" formControlName="content" spellcheck="false" [placeholder]="documentContentExample" [nzAutosize]="{ minRows: 14, maxRows: 16 }"></textarea>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div nz-row>
      <div nz-col nzSpan="24">
        <nz-form-item>
          <nz-form-label [nzSpan]="10" [nzNoColon]="true">
            <label nz-checkbox formControlName="duplicate"><span translate>Duplicate document?</span></label>
          </nz-form-label>
          <nz-form-control [nzSpan]="12" nzErrorTip="{{ 'please enter a valid numeric value' | translate }}">
            <nz-input-number
              formControlName="duplicateTimes"
              [nzMin]="2"
              [nzMax]="100"
              [nzStep]="1"
              [nzFormatter]="formatterDuplicateTimes"
              [nzParser]="parserDuplicateTimes"
              [nzDisabled]="!addDocumentForm.controls.duplicate.value"
            ></nz-input-number>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <div class="drawer-footer">
      <button nz-button nzType="default" (click)="isAddDocumentDrawerVisible = false" [ngStyle]="{ 'margin-right': '8px' }"><span translate>Cancel</span></button>
      <button nz-button nzType="primary" [nzLoading]="isAddDocumentButtonLoading" (click)="onAddDocumentClick()"><span translate>Add</span></button>
    </div>
  </form>
</nz-drawer>
<nz-modal
  *ngIf="isSaveModalVisible"
  [(nzVisible)]="isSaveModalVisible"
  nzTitle="{{ 'Unsaved Changes' | translate }}"
  nzOkText="{{ 'Save' | translate }}"
  nzCancelText="{{ 'Cancel' | translate }}"
  nzWidth="60%"
  (nzOnCancel)="isSaveModalVisible = false"
  (nzOnOk)="onSaveChangesClick()"
  [nzOkLoading]="isSaveButtonLoading"
  [nzOkDisabled]="isSaveButtonDisabled"
>
  <fm-cache-diff
    [diffStyle]="options.diffStyle"
    [outputFormat]="options.diffOutputFormat"
    [enableSaveButton]="isSaveButtonDisabled"
    (enableSaveButtonChange)="onSaveButtonStatusChange($event)"
  ></fm-cache-diff>
  <nz-alert
    *ngIf="!isSaveButtonDisabled"
    nzBanner
    nzMessage="{{ 'Once saved, the above changes will override your existing firestore data. This operation is not reversible!' | translate }}"
    nzCloseable
    [ngStyle]="{ 'margin-top': '20px' }"
  ></nz-alert>
</nz-modal>
<nz-drawer
  *ngIf="!isWebExtension && (isSettingsDrawerVisible || isSettingsDrawerLoaded)"
  [nzClosable]="false"
  [nzOffsetX]="0"
  [nzWidth]="500"
  [nzVisible]="isSettingsDrawerVisible"
  nzTitle="{{ 'Settings' | translate }}"
  (nzOnClose)="onSettingsDrawerClose()"
>
  <nz-spin nzTip="{{ 'Loading' | translate }}..." [nzSpinning]="!isSettingsDrawerLoaded">
    <iframe src="./options" width="100%" frameBorder="0" (load)="isSettingsDrawerLoaded = true" [ngStyle]="{ 'min-height': '200px' }"></iframe>
  </nz-spin>
</nz-drawer>
